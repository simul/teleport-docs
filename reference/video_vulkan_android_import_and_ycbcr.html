<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video with Vulkan on Android &mdash; Teleport VR  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="The Teleport VR Protocol" href="../protocol.html" />
    <link rel="prev" title="Video Decoding with Android NDK" href="video_ndk_decoding.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
			<a href="../index.html"  class="" >
				
					<span class="sidebartitle">
						Teleport VR
					</span>
				
					<img src="../_static/TeleportLogo-64.png" class="logo" alt="Logo" />
			</a>
<div role="search">
    <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
        <label class="search-label" for="q">Search the teleport documentation</label>
        <input type="text" name="q" id="q" placeholder="Search..." aria-label="Search docs" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client/index.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unity/index.html">Teleport Unity SDK</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Reference Implementation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="libavstream.html">LibAVStream</a></li>
<li class="toctree-l2"><a class="reference internal" href="libavstream_example.html">LibAVStream Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="clientrenderer.html">Client Render Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="teleportclient.html">The Teleport Client library</a></li>
<li class="toctree-l2"><a class="reference internal" href="server.html">Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="video_ndk_decoding.html">Video Decoding with Android NDK</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Video with Vulkan on Android</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#importing-a-video-stream-into-vulkan">Importing a Video Stream into Vulkan</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vulkan-sampler-ycbcr-conversion">Vulkan Sampler YCbCr Conversion</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ycbcr-colour-space">YCbCr Colour Space</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chroma-subsampling">Chroma Subsampling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interleaved-planar-and-semi-planar">Interleaved, Planar and Semi Planar</a></li>
<li class="toctree-l4"><a class="reference internal" href="#itu-colour-spaces-and-encoding-ranges">ITU Colour Spaces and Encoding Ranges</a></li>
<li class="toctree-l4"><a class="reference internal" href="#co-sited-vs-midpoint">Co-sited vs Midpoint</a></li>
<li class="toctree-l4"><a class="reference internal" href="#simul-s-implementation">Simul’s Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ycbcr-in-compute-shaders-and-load-operations">YCbCr in Compute Shaders and Load Operations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#classes">Classes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../protocol.html">The Teleport VR Protocol</a></li>
</ul>

        </div>
      </div>
    </nav>

    <div data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
		<h2 class="wy-nav-top">Navigation</h2><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Teleport VR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Reference Implementation</a></li>
      <li class="breadcrumb-item active">Video with Vulkan on Android</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/reference/video_vulkan_android_import_and_ycbcr.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="video-with-vulkan-on-android">
<span id="video-vulkan-android-import-and-ycbcr"></span><h1>Video with Vulkan on Android<a class="headerlink" href="#video-with-vulkan-on-android" title="Permalink to this heading">¶</a></h1>
<p>Simul’s Android client supports the decoding of video streams through the use of the Android NDK AMedia and AImage libraries. See <a class="reference internal" href="video_ndk_decoding.html#video-ndk-decoding"><span class="std std-ref">Video Decoding with Android NDK</span></a>. We currently require the support of these two Vulkan device extensions:</p>
<ul class="simple">
<li><p>VK_KHR_sampler_ycbcr_conversion (<a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/man/html/VK_KHR_sampler_ycbcr_conversion.html">https://registry.khronos.org/vulkan/specs/1.3-extensions/man/html/VK_KHR_sampler_ycbcr_conversion.html</a>).</p></li>
<li><p>VK_ANDROID_external_memory_android_hardware_buffer (<a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/man/html/VK_ANDROID_external_memory_android_hardware_buffer.html">https://registry.khronos.org/vulkan/specs/1.3-extensions/man/html/VK_ANDROID_external_memory_android_hardware_buffer.html</a>).</p></li>
</ul>
<p>When available from Khronos, that and suitable drivers and runtimes are available from the device vendors, we should optionally support:</p>
<ul class="simple">
<li><p>VK_KHR_video_queue (<a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap50.html#VK_KHR_video_queue">https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap50.html#VK_KHR_video_queue</a>)</p></li>
<li><p>VK_KHR_video_decode_queue (<a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap50.html#VK_KHR_video_decode_queue">https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap50.html#VK_KHR_video_decode_queue</a>)</p></li>
<li><p>VK_KHR_video_decode_h264 (<a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap50.html#VK_EXT_video_encode_h264">https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap50.html#VK_EXT_video_encode_h264</a>)</p></li>
<li><p>VK_KHR_video_decode_h265 (<a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap50.html#VK_EXT_video_encode_h265">https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap50.html#VK_EXT_video_encode_h265</a>)</p></li>
</ul>
<section id="importing-a-video-stream-into-vulkan">
<h2>Importing a Video Stream into Vulkan<a class="headerlink" href="#importing-a-video-stream-into-vulkan" title="Permalink to this heading">¶</a></h2>
<p>Simul’s Android client has <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">teleport::android::NdkVideoDecoder</span></code> that interfaces with <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">teleport::android::VideoDecoderBackend</span></code>, which extends <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">avs::DecoderBackendInterface</span></code>. The NdkVideoDecoder sets up a <code class="docutils literal notranslate"><span class="pre">AMediaCodec</span></code> Decoder and <code class="docutils literal notranslate"><span class="pre">AImageListener</span></code>, from which an <code class="docutils literal notranslate"><span class="pre">AImage</span></code> and its <code class="docutils literal notranslate"><span class="pre">AHardwareBuffer</span></code> can be obtained. The <code class="docutils literal notranslate"><span class="pre">AHardwareBuffer</span></code> is obtained from the <code class="docutils literal notranslate"><span class="pre">AImage</span></code> by calling <code class="docutils literal notranslate"><span class="pre">AImage_getHardwareBuffer()</span></code>; and a <code class="docutils literal notranslate"><span class="pre">AHardwareBuffer_Desc</span></code> can also be obtained by calling <code class="docutils literal notranslate"><span class="pre">AHardwareBuffer_describe()</span></code>. From this point the <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">NdkVideoDecoder</span></code> uses the VK_ANDROID_external_memory_android_hardware_buffer extension to import the memory held by the <code class="docutils literal notranslate"><span class="pre">AHardwareBuffer</span></code> into Vulkan.
The following is brief description on how this is implemented:</p>
<ul class="simple">
<li><p>We call <code class="docutils literal notranslate"><span class="pre">vkGetAndroidHardwareBufferPropertiesANDROID()</span></code> filling out the chained structures: <code class="docutils literal notranslate"><span class="pre">VkAndroidHardwareBufferPropertiesANDROID</span></code> and <code class="docutils literal notranslate"><span class="pre">VkAndroidHardwareBufferFormatPropertiesANDROID</span></code>.</p></li>
<li><p>From <code class="docutils literal notranslate"><span class="pre">VkAndroidHardwareBufferFormatPropertiesANDROID::externalFormat</span></code>, the device/vendors specific format can be obtained.</p></li>
<li><p>We fill out a <code class="docutils literal notranslate"><span class="pre">VkExternalFormatANDROID</span></code> structure using <code class="docutils literal notranslate"><span class="pre">VkAndroidHardwareBufferFormatPropertiesANDROID::externalFormat</span></code>. The <code class="docutils literal notranslate"><span class="pre">VkExternalFormatANDROID</span></code> structure is chained into a <code class="docutils literal notranslate"><span class="pre">VkExternalMemoryImageCreateInfo</span></code> structure, and we bitwise set <code class="docutils literal notranslate"><span class="pre">VkExternalMemoryImageCreateInfo::handleTypes</span></code> to include <code class="docutils literal notranslate"><span class="pre">VK_EXTERNAL_MEMORY_HANDLE_TYPE_ANDROID_HARDWARE_BUFFER_BIT_ANDROID</span></code>.</p></li>
<li><p>We fill out a <code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo</span></code> structure chaining in the <code class="docutils literal notranslate"><span class="pre">VkExternalMemoryImageCreateInfo</span></code> structure. The Vulkan specification requires the <code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo</span></code> structure to be set up as follows:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo::flags</span></code> to <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo::imageType</span></code> to <code class="docutils literal notranslate"><span class="pre">VK_IMAGE_TYPE_2D</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo::format</span></code> to <code class="docutils literal notranslate"><span class="pre">VK_FORMAT_UNDEFINED</span></code> (This defined in the <code class="docutils literal notranslate"><span class="pre">VkExternalFormatANDROID</span></code> structure).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo::extent</span></code> equal to that of the image size specified in the <code class="docutils literal notranslate"><span class="pre">AMediaCodec</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo::mipLevels</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo::arrayLayers</span></code> equal to that of <code class="docutils literal notranslate"><span class="pre">AHardwareBuffer_Desc::layers</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo::samples</span></code> to <code class="docutils literal notranslate"><span class="pre">VK_SAMPLE_COUNT_1_BIT</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo::tiling</span></code> to <code class="docutils literal notranslate"><span class="pre">VK_IMAGE_TILING_OPTIMAL</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo::usage</span></code> to <code class="docutils literal notranslate"><span class="pre">VK_IMAGE_USAGE_SAMPLED_BIT</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo::sharingMode</span></code> to <code class="docutils literal notranslate"><span class="pre">VK_SHARING_MODE_EXCLUSIVE</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo::queueFamilyIndexCount</span></code> to <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo::pQueueFamilyIndices</span></code> to <code class="docutils literal notranslate"><span class="pre">nullptr</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VkImageCreateInfo::initialLayout</span></code> to <code class="docutils literal notranslate"><span class="pre">VK_IMAGE_LAYOUT_UNDEFINED</span></code>.</p></li>
</ul>
</li>
<li><p>We call <code class="docutils literal notranslate"><span class="pre">vkCreateImage()</span></code>.</p></li>
<li><p>We fill out a <code class="docutils literal notranslate"><span class="pre">VkMemoryDedicatedAllocateInfo</span></code> structure setting <code class="docutils literal notranslate"><span class="pre">VkMemoryDedicatedAllocateInfo::image</span></code> to the <code class="docutils literal notranslate"><span class="pre">VkImage</span></code> created previously. Vulkan requires that <code class="docutils literal notranslate"><span class="pre">VkImage``s</span> <span class="pre">that</span> <span class="pre">are</span> <span class="pre">to</span> <span class="pre">be</span> <span class="pre">backed</span> <span class="pre">by</span> <span class="pre">an</span> <span class="pre">``AHardwareBuffer</span></code> be a dedicated allocation. We fill out a <code class="docutils literal notranslate"><span class="pre">VkImportAndroidHardwareBufferInfoANDROID</span></code> structure chaining in the previous <code class="docutils literal notranslate"><span class="pre">VkMemoryDedicatedAllocateInfo</span></code> structure and setting <code class="docutils literal notranslate"><span class="pre">VkImportAndroidHardwareBufferInfoANDROID::buffer</span></code> to the <code class="docutils literal notranslate"><span class="pre">AHardwareBuffer</span></code> obtained from the <code class="docutils literal notranslate"><span class="pre">AMediaCodec</span></code>’s <code class="docutils literal notranslate"><span class="pre">AImage</span></code> output.</p></li>
<li><p>We fill out a <code class="docutils literal notranslate"><span class="pre">VkMemoryAllocateInfo</span></code> structure chaining in the <code class="docutils literal notranslate"><span class="pre">VkMemoryDedicatedAllocateInfo</span></code> structure. We set <code class="docutils literal notranslate"><span class="pre">VkMemoryAllocateInfo::allocationSize</span></code> equal to the <code class="docutils literal notranslate"><span class="pre">VkAndroidHardwareBufferPropertiesANDROID::allocationSize</span></code>.</p></li>
<li><p>We use <code class="docutils literal notranslate"><span class="pre">VkAndroidHardwareBufferPropertiesANDROID::memoryTypeBits</span></code> to select a Memory Type Index for Vulkan to use, and we set that index value into <code class="docutils literal notranslate"><span class="pre">VkMemoryAllocateInfo::memoryTypeIndex</span></code>. We also ensure that the selected Memory Type has the <code class="docutils literal notranslate"><span class="pre">VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT</span></code> associated with it.</p></li>
<li><p>We call <code class="docutils literal notranslate"><span class="pre">vkAllocateMemory()</span></code>. Depending on the device vendor’s implementation of the Vulkan specification in its runtime, the implementation will at worse copy the contents of the <code class="docutils literal notranslate"><span class="pre">AHardwareBuffer</span></code> to a different memory location valid for use in Vulkan, or at best map the memory address to the created <code class="docutils literal notranslate"><span class="pre">VkDeviceMemory</span></code>.</p></li>
<li><p>We call <code class="docutils literal notranslate"><span class="pre">vkBindImageMemory()</span></code> backing the <code class="docutils literal notranslate"><span class="pre">VkImage</span></code> with the <code class="docutils literal notranslate"><span class="pre">VkDeviceMemory</span></code>, which is itself ‘backed’ by the <code class="docutils literal notranslate"><span class="pre">AHardwareBuffer</span></code>.</p></li>
<li><p>We store the <code class="docutils literal notranslate"><span class="pre">VkImage</span></code> and <code class="docutils literal notranslate"><span class="pre">VkDeviceMemory</span></code> for later use and deletion.</p></li>
</ul>
<p>Flow chart:</p>
<a class="reference internal image-reference" href="../_images/AMediaCodecToVkImageAndVkDeviceMemory.png"><img alt="AMediaCodec to VkImage and VkDeviceMemory." src="../_images/AMediaCodecToVkImageAndVkDeviceMemory.png" style="width: 800px;" /></a>
</section>
<section id="vulkan-sampler-ycbcr-conversion">
<h2>Vulkan Sampler YCbCr Conversion<a class="headerlink" href="#vulkan-sampler-ycbcr-conversion" title="Permalink to this heading">¶</a></h2>
<p>Simul’s Rendering library <em>Platform</em> (<a class="reference external" href="https://github.com/simul/Platform/tree/dev">https://github.com/simul/Platform/tree/dev</a>) supports the use of YCbCr samplers for Vulkan.</p>
<section id="ycbcr-colour-space">
<h3>YCbCr Colour Space<a class="headerlink" href="#ycbcr-colour-space" title="Permalink to this heading">¶</a></h3>
<p>YCbCr is favoured over RGB for video broadcssting and streaming as the format implicitly compresses the video data, saving on bandwidth. YCbCr is based on the YUV standard for broadcast television, wherein the video signal is split into a luma (Y) and two chroma (Cb/Cr) components. It is vital to remember that the chroma components are defined to be the difference between the original colour and the luma signal, and therefore the chroma components are signed values ranging from -0.5 to 0.5, whereas the luma component ranges from 0.0 to 1.0, in a signed normalised co-ordinate space.</p>
<a class="reference internal image-reference" href="../_images/YCbCr.GIF"><img alt="The YCbCr colour space." src="../_images/YCbCr.GIF" style="width: 800px;" /></a>
<p>Reference: <a class="reference external" href="https://en.wikipedia.org/wiki/YCbCr">Wikipedia YCbCr</a>.</p>
</section>
<section id="chroma-subsampling">
<h3>Chroma Subsampling<a class="headerlink" href="#chroma-subsampling" title="Permalink to this heading">¶</a></h3>
<p>Further compression of the video data can be achieved by downsampling the chroma components without affecting the colour perspection. This is because the human eye is less sensitive to high frequency changes in colour data. Chroma Subsampling is expressed by three-part ratio J:a:b, such as 4:2:2.</p>
<ul class="simple">
<li><p>J: horizontal sampling reference (width of the conceptual region). Usually, 4.</p></li>
<li><p>a: number of chrominance samples (Cb, Cr) in the first row of J pixels.</p></li>
<li><p>b: number of changes of chrominance samples (Cb, Cr) between first and second row of J pixels.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/ChromaSubsampling.png"><img alt="Chroma Subsampling types." src="../_images/ChromaSubsampling.png" style="width: 800px;" /></a>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Chroma_subsampling">Wikipedia Chroma subsampling</a>.</p>
</section>
<section id="interleaved-planar-and-semi-planar">
<h3>Interleaved, Planar and Semi Planar<a class="headerlink" href="#interleaved-planar-and-semi-planar" title="Permalink to this heading">¶</a></h3>
<p>This qualifier refers to the how the data is organised in memory.</p>
<ul class="simple">
<li><p>An Interleaved layout means that the luma and chroma components are interleaved onto a single plane.</p></li>
<li><p>A Planar layout means that the luma and the two chroma components each have their own planes.</p></li>
<li><p>A Semi Planar layout means that the luma component has its own plane, and the chroma components are interleaved onto their single plane.</p></li>
</ul>
<style> .red {color:#FF0000} </style>
<style> .grn {color:#00CC00} </style>
<style> .blu {color:#0000FF} </style><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Type / Plane</p></th>
<th class="head"><p>0</p></th>
<th class="head"><p>1</p></th>
<th class="head"><p>2</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Interleaved</p></td>
<td><p><span class="grn">Y</span><span class="blu">U</span><span class="red">V</span></p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Planar</p></td>
<td><p><span class="grn">Y</span></p></td>
<td><p><span class="blu">U</span></p></td>
<td><p><span class="red">V</span></p></td>
</tr>
<tr class="row-even"><td><p>Semi Planar</p></td>
<td><p><span class="grn">Y</span></p></td>
<td><p><span class="blu">U</span><span class="red">V</span></p></td>
<td></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head" colspan="3"><p>4:2:2</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>UYVY</p></td>
<td><p>Interleaved</p></td>
<td><p><span class="blu">U0</span> <span class="grn">Y0</span> <span class="red">V0</span> <span class="grn">Y1</span> <span class="blu">U1</span> <span class="grn">Y2</span> <span class="red">V1</span> <span class="grn">Y3</span> <span class="blu">U2</span> <span class="grn">Y4</span> <span class="red">V2</span> <span class="grn">Y5</span> <span class="blu">U3</span> <span class="grn">Y6</span> <span class="red">V3</span> <span class="grn">Y7</span></p></td>
</tr>
<tr class="row-odd"><td><p>YUY2</p></td>
<td><p>Interleaved</p></td>
<td><p><span class="grn">Y0</span> <span class="blu">U0</span> <span class="grn">Y1</span> <span class="red">V0</span> <span class="grn">Y2</span> <span class="blu">U1</span> <span class="grn">Y3</span> <span class="red">V1</span> <span class="grn">Y4</span> <span class="blu">U2</span> <span class="grn">Y5</span> <span class="red">V2</span> <span class="grn">Y6</span> <span class="blu">U3</span> <span class="grn">Y7</span> <span class="red">V3</span></p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head" colspan="3"><p>4:2:0</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>I420</p></td>
<td><p>Planar</p></td>
<td><p><span class="grn">Y1</span> <span class="grn">Y2</span> <span class="grn">Y3</span> <span class="grn">Y4</span> <span class="grn">Y5</span> <span class="grn">Y6</span> <span class="grn">Y7</span> <span class="grn">Y8</span> <span class="blu">U1</span> <span class="blu">U2</span> <span class="red">V1</span> <span class="red">V2</span></p></td>
</tr>
<tr class="row-odd"><td><p>YV12</p></td>
<td><p>Planar</p></td>
<td><p><span class="grn">Y1</span> <span class="grn">Y2</span> <span class="grn">Y3</span> <span class="grn">Y4</span> <span class="grn">Y5</span> <span class="grn">Y6</span> <span class="grn">Y7</span> <span class="grn">Y8</span> <span class="red">V1</span> <span class="red">V2</span> <span class="blu">U1</span> <span class="blu">U2</span></p></td>
</tr>
<tr class="row-even"><td><p>NV12</p></td>
<td><p>Semi Planar</p></td>
<td><p><span class="grn">Y1</span> <span class="grn">Y2</span> <span class="grn">Y3</span> <span class="grn">Y4</span> <span class="grn">Y5</span> <span class="grn">Y6</span> <span class="grn">Y7</span> <span class="grn">Y8</span> <span class="blu">U1</span> <span class="red">V1</span> <span class="blu">U2</span> <span class="red">V2</span></p></td>
</tr>
<tr class="row-odd"><td><p>NV21</p></td>
<td><p>Semi Planar</p></td>
<td><p><span class="grn">Y1</span> <span class="grn">Y2</span> <span class="grn">Y3</span> <span class="grn">Y4</span> <span class="grn">Y5</span> <span class="grn">Y6</span> <span class="grn">Y7</span> <span class="grn">Y8</span> <span class="red">V1</span> <span class="blu">U1</span> <span class="red">V2</span> <span class="blu">U2</span></p></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="../_images/YUV_formats.png"><img alt="Layouts of alternative colour formats." src="../_images/YUV_formats.png" style="width: 800px;" /></a>
<a class="reference internal image-reference" href="../_images/800px-Yuv420.svg.png"><img alt="Layout of a YUV420 image." src="../_images/800px-Yuv420.svg.png" style="width: 800px;" /></a>
<p>Reference: <a class="reference external" href="https://wiki.videolan.org/YUV">Video LAN Wiki YUV</a>.</p>
<p>Reference: <a class="reference external" href="https://gist.github.com/Jim-Bar/3cbba684a71d1a9d468a6711a6eddbeb">About YUV formats</a>.</p>
<p>Reference: <a class="reference external" href="https://en.wikipedia.org/wiki/YUV#Y%E2%80%B2UV420p_(and_Y%E2%80%B2V12_or_YV12)_to_RGB888_conversion">Wikipedia Y′UV420p (and Y′V12 or YV12) to RGB888 conversion</a>.</p>
</section>
<section id="itu-colour-spaces-and-encoding-ranges">
<h3>ITU Colour Spaces and Encoding Ranges<a class="headerlink" href="#itu-colour-spaces-and-encoding-ranges" title="Permalink to this heading">¶</a></h3>
<p>As YCbCr is the digital version of the analogue television standard YUV, the ITU (International Telecommunication Union) has defined both the colour spaces and the quantisations the three colour space standards.</p>
<p>The primaries below can be used to create a 3 x 3 matrix that can convert to and from RGB to YCbCr colour spaces. The primaries in the table below are just the luma (Y) component of these colour standards based in the CIE xyY colour space. See reference: <a class="reference external" href="https://en.wikipedia.org/wiki/CIE_1931_color_space#CIE_xy_chromaticity_diagram_and_the_CIE_xyY_color_space">Wikipedia CIE 1931 color space: CIE xy chromaticity diagram and the CIE xyY color space</a>.</p>
<p>In terms of the encoding range, the ITU reserved regions at the beginning and end of each ‘representable integer range for rounding errors and for signal control data’. These reversed regions mean that the video data has a <em>narrow range</em> encoding, and their absence means that the video source has <em>full range</em> encoding. Currently, only BT.2100 requires full range encoding: All others use the narrow range encoding.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>ITU Standard</p></td>
<td><p>TV Format</p></td>
<td><p>Red Primary</p></td>
<td><p>Green Primary</p></td>
<td><p>Blue Primary</p></td>
</tr>
<tr class="row-even"><td><p>BT.601</p></td>
<td><p>SD</p></td>
<td><p>0.299</p></td>
<td><p>0.587</p></td>
<td><p>0.114</p></td>
</tr>
<tr class="row-odd"><td><p>BT.709</p></td>
<td><p>HD</p></td>
<td><p>0.2126</p></td>
<td><p>0.7152</p></td>
<td><p>0.0722</p></td>
</tr>
<tr class="row-even"><td><p>BT.2020</p></td>
<td><p>UHD</p></td>
<td><p>0.2627</p></td>
<td><p>0.6780</p></td>
<td><p>0.0593</p></td>
</tr>
</tbody>
</table>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">How to create a 3 x 3 matrix that can convert to and from RGB to YCbCr colour spaces.</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="n">float3x3</span><span class="w"> </span><span class="nf">YCbCrToRGB_ConversionMatrix</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">type</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">              </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<span class="w">              </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                      </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                              </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Colour_BT601_PrimaryR</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">                              </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Colour_BT601_PrimaryG</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">                              </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Colour_BT601_PrimaryB</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">                              </span><span class="k">break</span><span class="p">;</span>
<span class="w">                      </span><span class="p">}</span>
<span class="w">                      </span><span class="k">default</span><span class="o">:</span>
<span class="w">                      </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                              </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Colour_BT709_PrimaryR</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">                              </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Colour_BT709_PrimaryG</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">                              </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Colour_BT709_PrimaryB</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">                              </span><span class="k">break</span><span class="p">;</span>
<span class="w">                      </span><span class="p">}</span>
<span class="w">                      </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                              </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Colour_BT2020_PrimaryR</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">                              </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Colour_BT2020_PrimaryG</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">                              </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Colour_BT2020_PrimaryB</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="w">                              </span><span class="k">break</span><span class="p">;</span>
<span class="w">                      </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">              </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
<span class="w">              </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">);</span>

<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">float3x3</span><span class="p">(</span>
<span class="w">                      </span><span class="n">float3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w">                </span><span class="mf">0.0</span><span class="p">,</span><span class="w">                  </span><span class="n">e</span><span class="p">),</span>
<span class="w">                      </span><span class="n">float3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mf">-1.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">b</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mf">-1.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">b</span><span class="p">)),</span>
<span class="w">                      </span><span class="n">float3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w">                  </span><span class="n">d</span><span class="p">,</span><span class="w">                </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">              </span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="p">{</span>
<span class="w">              </span><span class="n">float3</span><span class="w"> </span><span class="n">Y1CbCr</span><span class="p">;</span>
<span class="w">              </span><span class="n">float3</span><span class="w"> </span><span class="n">RGB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mul</span><span class="p">(</span><span class="n">Y1CbCr</span><span class="p">,</span><span class="w"> </span><span class="n">YCbCrToRGB_ConversionMatrix_Fast</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
<span class="w">      </span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Reference: <a class="reference external" href="https://registry.khronos.org/DataFormat/specs/1.3/dataformat.1.3.html#PRIMARY_CONVERSION">Khronos Colour Space Conversions</a></p>
<p>Reference: <a class="reference external" href="https://registry.khronos.org/DataFormat/specs/1.3/dataformat.1.3.html#CONVERSION_QUANTIZATION">Khronos Colour Space Quantisation</a></p>
</section>
<section id="co-sited-vs-midpoint">
<h3>Co-sited vs Midpoint<a class="headerlink" href="#co-sited-vs-midpoint" title="Permalink to this heading">¶</a></h3>
<p>Due to the downsampling of the chroma components, when loading a YCbCr image for use in a shader, it is required that the full chroma samples are reconstructed from the lower spatial resolution of the chrominance planes. The two offset methods are <em>Co-sited</em> and <em>Midpoint</em>. Figures 5 - 10 in Section 16.3.8. of the Vulkan Specification show how the rescaled chroma plane(s) are overlayed on top of the luma plane for 4:2:2 and 4:2:0 in all varying combinations of Co-sited and Midpoint for X and Y.
The downsampling method used on the server must match the upsampling method used on the Android client for the chrominance data to be reconstructed accurately.</p>
<p>Reference: <a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3/html/chap16.html#textures-chroma-reconstruction">Khronos Chroma Reconstruction</a></p>
</section>
<section id="simul-s-implementation">
<h3>Simul’s Implementation<a class="headerlink" href="#simul-s-implementation" title="Permalink to this heading">¶</a></h3>
<p>Simul’s Implementation uses 4:2:0 NV12 Semi Planar, BT.709.
On Meta Quest and Meta Quest 2, the <code class="docutils literal notranslate"><span class="pre">AMediaCodec</span></code> selects a vendor specific format <code class="docutils literal notranslate"><span class="pre">OMX_QCOM_COLOR_FormatYUV420PackedSemiPlanar32m</span></code>. This is <a class="reference external" href="https://www.khronos.org/openmax/">Khronos OpenMax</a> <a class="reference external" href="https://www.qualcomm.com/home">Qualcomm</a> extension that is specific to Qualcomm SoCs (System On Chip) such as the Snapdragon 835/Adreno 540 (Meta Quest) and the Qualcomm Snapdragon XR2/Adreno 650 (Meta Quest 2).</p>
<p>We create a <code class="docutils literal notranslate"><span class="pre">VKSamplerYcbcrConversionKHR</span></code> from a <code class="docutils literal notranslate"><span class="pre">VkSamplerYcbcrConversionCreateInfoKHR</span></code>. The majority of the memebers of the structure can filled out using the <code class="docutils literal notranslate"><span class="pre">VkAndroidHardwareBufferFormatPropertiesANDROID</span></code> structure acquired earlier. Here again <code class="docutils literal notranslate"><span class="pre">VkSamplerYcbcrConversionCreateInfoKHR::format</span></code> is set to <code class="docutils literal notranslate"><span class="pre">VK_FORMAT_UNDEFINED</span></code> as the format is defined in the chained <code class="docutils literal notranslate"><span class="pre">VkExternalFormatANDROID</span></code> structure. <code class="docutils literal notranslate"><span class="pre">VkComponentMapping</span></code> is set to <code class="docutils literal notranslate"><span class="pre">VK_COMPONENT_SWIZZLE_IDENTITY</span></code> for the R, G, B and A values. The component remapping is useful for when the Cb and Cr components are swapped such as the NV21 memory layout for 4:2:0. For <code class="docutils literal notranslate"><span class="pre">VkSamplerYcbcrConversionCreateInfoKHR::chromaFilter</span></code> we use <code class="docutils literal notranslate"><span class="pre">VK_FILTER_NEAREST</span></code> so as not to ‘blend’ between the chrominance pixels, and we disable <code class="docutils literal notranslate"><span class="pre">VkSamplerYcbcrConversionCreateInfoKHR::forceExplicitReconstruction</span></code>.</p>
<p>With the <code class="docutils literal notranslate"><span class="pre">VKSamplerYcbcrConversionKHR</span></code> created, we assign this to <code class="docutils literal notranslate"><span class="pre">VkSamplerYcbcrConversionInfoKHR::conversion</span></code> and chain the <code class="docutils literal notranslate"><span class="pre">VkSamplerYcbcrConversionInfoKHR</span></code> structure into a <code class="docutils literal notranslate"><span class="pre">VkSamplerCreateInfo</span></code> structure for <code class="docutils literal notranslate"><span class="pre">platform::vulkan::RenderPlatform</span></code>’s single video sampler and into a <code class="docutils literal notranslate"><span class="pre">VkImageViewCreateInfo</span></code> structure for each instance of <code class="docutils literal notranslate"><span class="pre">platform::vulkan::Texture</span></code> where a YCbCr conversion is needed.</p>
<a class="reference internal image-reference" href="../_images/VKSamplerYcbcrConversionKHRCreationAndSetUpForVkImageViewAndVkSampler.png"><img alt="VKSamplerYcbcrConversionKHR creation and set up for VkImageView and VkSampler." src="../_images/VKSamplerYcbcrConversionKHRCreationAndSetUpForVkImageViewAndVkSampler.png" style="width: 800px;" /></a>
</section>
<section id="ycbcr-in-compute-shaders-and-load-operations">
<h3>YCbCr in Compute Shaders and Load Operations<a class="headerlink" href="#ycbcr-in-compute-shaders-and-load-operations" title="Permalink to this heading">¶</a></h3>
<p>Presently, the video sampler is unused, as we do a HLSL: <code class="docutils literal notranslate"><span class="pre">Texture2D.Load()</span></code> / GLSL: <code class="docutils literal notranslate"><span class="pre">texelFetch()</span></code> operation in a compute shader. The previous information used to create <code class="docutils literal notranslate"><span class="pre">VKSamplerYcbcrConversionKHR</span></code>, and that was ultimately passed to the <code class="docutils literal notranslate"><span class="pre">VkImageView</span></code>, is still used to reconstruct the chrominance data, returning the separated <span class="grn">Y</span>, <span class="blu">U</span> and <span class="red">V</span> components as if it were a 4:4:4 Planar YCbCr image. The load operation converts the 8-bit unsigned integer (0 - 255) to a normalised floating point 32-bit value (0.0 - 1.0). This works fine for the luma component, but the chroma need to offset by -0.5, putting them in the range (-0.5 - 0.5) to match the YCbCr colour space. The load operation assigns the Y, Cb and Cb channels to the RGB channels as follows:</p>
<ul class="simple">
<li><p><span class="grn">Y =&gt; G</span>.</p></li>
<li><p><span class="blu">U =&gt; B</span>.</p></li>
<li><p><span class="red">V =&gt; R</span>.</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Loading a YCbCr texture in a compute shader.</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="n">Texture2D</span><span class="o">&lt;</span><span class="n">float4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ycbcrTexture</span><span class="p">;</span>
<span class="w">      </span><span class="n">RWTexture2D</span><span class="o">&lt;</span><span class="n">float4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rgbTexture</span><span class="p">;</span>

<span class="w">      </span><span class="n">float3x3</span><span class="w"> </span><span class="nf">YCbCrToRGB_ConversionMatrix_Fast</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">type</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">              </span><span class="n">float3x3</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">              </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
<span class="w">              </span><span class="p">{</span>

<span class="w">                      </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                              </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">float3x3</span><span class="p">(</span>
<span class="w">                                      </span><span class="n">float3</span><span class="p">(</span><span class="o">+</span><span class="mf">1.000</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">0.000</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">1.402</span><span class="p">),</span>
<span class="w">                                      </span><span class="n">float3</span><span class="p">(</span><span class="o">+</span><span class="mf">1.000</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.344</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.714</span><span class="p">),</span>
<span class="w">                                      </span><span class="n">float3</span><span class="p">(</span><span class="o">+</span><span class="mf">1.000</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">1.772</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">0.000</span><span class="p">));</span>
<span class="w">                              </span><span class="k">break</span><span class="p">;</span>
<span class="w">                      </span><span class="p">}</span>
<span class="w">                      </span><span class="k">default</span><span class="o">:</span>
<span class="w">                      </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                              </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">float3x3</span><span class="p">(</span>
<span class="w">                                      </span><span class="n">float3</span><span class="p">(</span><span class="o">+</span><span class="mf">1.0000</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">0.0000</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">1.5748</span><span class="p">),</span>
<span class="w">                                      </span><span class="n">float3</span><span class="p">(</span><span class="o">+</span><span class="mf">1.0000</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.1873</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.4681</span><span class="p">),</span>
<span class="w">                                      </span><span class="n">float3</span><span class="p">(</span><span class="o">+</span><span class="mf">1.0000</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">1.8556</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">0.0000</span><span class="p">));</span>
<span class="w">                              </span><span class="k">break</span><span class="p">;</span>
<span class="w">                      </span><span class="p">}</span>
<span class="w">                      </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                              </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">float3x3</span><span class="p">(</span>
<span class="w">                                      </span><span class="n">float3</span><span class="p">(</span><span class="o">+</span><span class="mf">1.0000</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">0.0000</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">1.4746</span><span class="p">),</span>
<span class="w">                                      </span><span class="n">float3</span><span class="p">(</span><span class="o">+</span><span class="mf">1.0000</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.1646</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5714</span><span class="p">),</span>
<span class="w">                                      </span><span class="n">float3</span><span class="p">(</span><span class="o">+</span><span class="mf">1.0000</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">1.8814</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">0.0000</span><span class="p">));</span>
<span class="w">                              </span><span class="k">break</span><span class="p">;</span>
<span class="w">                      </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kt">void</span><span class="w"> </span><span class="nf">CS_ConvertYCbCrToRGB</span><span class="p">(</span><span class="n">uint3</span><span class="w"> </span><span class="n">position</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">type</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">              </span><span class="n">float3</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ycbcrTexture</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="n">int3</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)).</span><span class="n">rgb</span><span class="p">;</span>
<span class="w">              </span><span class="kt">float</span><span class="w"> </span><span class="n">Cr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span>
<span class="w">              </span><span class="kt">float</span><span class="w"> </span><span class="n">Cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span>
<span class="w">              </span><span class="kt">float</span><span class="w"> </span><span class="n">Y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>

<span class="w">              </span><span class="n">vec4</span><span class="w"> </span><span class="n">clr</span><span class="p">;</span>
<span class="w">              </span><span class="n">clr</span><span class="p">.</span><span class="n">rgb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mul</span><span class="p">(</span><span class="n">float3</span><span class="p">(</span><span class="n">Y1</span><span class="p">,</span><span class="w"> </span><span class="n">Cb</span><span class="p">,</span><span class="w"> </span><span class="n">Cr</span><span class="p">),</span><span class="w"> </span><span class="n">YCbCrToRGB_ConversionMatrix_Fast</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
<span class="w">              </span><span class="n">clr</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">              </span><span class="n">rgbTexture</span><span class="p">[</span><span class="n">position</span><span class="p">.</span><span class="n">xy</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clr</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="p">[</span><span class="n">numthreads</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)]</span>
<span class="w">      </span><span class="n">shader</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">CS_ConvertYCbCrToRGB_BT709</span><span class="p">(</span><span class="n">uint3</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">              </span><span class="n">CS_ConvertYCbCrToRGB</span><span class="p">(</span><span class="n">position</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="classes">
<h3>Classes<a class="headerlink" href="#classes" title="Permalink to this heading">¶</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenclass: Cannot find class “teleport::android::NdkVideoDecoder” in doxygen xml output for project “TeleportVR” from directory: G:/Jarvis/workspace/Teleport/Teleport/build_docs/docs/doxygen/xml</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenclass: Cannot find class “teleport::android::VideoDecoderBackend” in doxygen xml output for project “TeleportVR” from directory: G:/Jarvis/workspace/Teleport/Teleport/build_docs/docs/doxygen/xml</p>
</div>
<dl class="cpp class">
<dt class="sig sig-object cpp" id="_CPPv4N3avs23DecoderBackendInterfaceE">
<span id="_CPPv3N3avs23DecoderBackendInterfaceE"></span><span id="_CPPv2N3avs23DecoderBackendInterfaceE"></span><span id="avs::DecoderBackendInterface"></span><span class="target" id="classavs_1_1_decoder_backend_interface"></span><span class="k"><span class="pre">class</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">DecoderBackendInterface</span></span></span><span class="w"> </span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="k"><span class="pre">public</span></span><span class="w"> </span><span class="n"><span class="pre">avs</span></span><span class="p"><span class="pre">::</span></span><a class="reference internal" href="libavstream.html#_CPPv4N3avs20UseInternalAllocatorE" title="avs::UseInternalAllocator"><span class="n"><span class="pre">UseInternalAllocator</span></span></a><br /></dt>
<dd><p>Common decoder backend interface.</p>
<p><a class="reference internal" href="libavstream.html#classavs_1_1_decoder"><span class="std std-ref">Decoder</span></a> backend is responsible for decoding compressed video data using a particular hardware decoder. Decoded video frames are outputted to a registered surface. </p>
<p>Subclassed by clientrender::VideoDecoderBackend</p>
</dd></dl>

</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="video_ndk_decoding.html" class="btn btn-neutral float-left" title="Video Decoding with Android NDK" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../protocol.html" class="btn btn-neutral float-right" title="The Teleport VR Protocol" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2023, Simul Software Ltd.</p>
  </div> 

</footer>
        </div>
      </div>
    </div>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>